<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöÄ Space News & Updates</title>
  <meta name="description" content="Live, categorized space news from NASA, Space.com, Spaceflight Now, BBC Science, Google News RSS, and more." />
  <style>
    /* ============ CSS VARIABLES (Light/Dark via data-theme) ============ */
    :root {
      --bg: #0b1020;
      --bg-elev: #11162b;
      --card: #151a2b;
      --card-2: #1b213b;
      --text: #e9eefc;
      --muted: #a7b1cc;
      --line: #26304f;
      --accent: #77e0ff;
      --accent-2: #a78bfa;
      --good: #7cf3c0;
      --bad: #ff7676;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --blur: saturate(1.1) blur(0px);
      --radius: 16px;
    }
    html[data-theme="light"] {
      --bg: #f6f8ff;
      --bg-elev: #ffffff;
      --card: #ffffff;
      --card-2: #f2f5ff;
      --text: #0f1533;
      --muted: #4c5776;
      --line: #d4daf0;
      --accent: #0066ff;
      --accent-2: #8b5cf6;
      --good: #0aa36c;
      --bad: #e53935;
      --shadow: 0 10px 30px rgba(0, 18, 69, .15);
    }

    /* ============ GLOBAL RESET ============ */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a { color: inherit; text-decoration: none; }
    img { max-width: 100%; display: block; }

    .container {
      width: min(1200px, 92vw);
      margin: 0 auto;
    }

    /* ============ HEADER (Hero) ============ */
    .hero {
      position: relative;
      overflow: hidden;
      padding: clamp(28px, 5vw, 44px) 0 clamp(18px, 3vw, 28px);
      background: radial-gradient(1200px 400px at 10% -10%, #2a2f60 0%, transparent 60%),
                  radial-gradient(900px 450px at 90% -20%, #44306b 0%, transparent 55%),
                  linear-gradient(180deg, #0b1020 0%, #0b1020 100%);
      border-bottom: 1px solid var(--line);
      isolation: isolate;
    }
    /* Starry twinkle overlay */
    .hero::before, .hero::after {
      content: "";
      position: absolute;
      inset: -50px -20px;
      background-image:
        radial-gradient(2px 2px at 10% 30%, rgba(255,255,255,.9) 50%, transparent 60%),
        radial-gradient(2px 2px at 30% 70%, rgba(255,255,255,.6) 50%, transparent 60%),
        radial-gradient(2px 2px at 60% 20%, rgba(255,255,255,.7) 50%, transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 60%, rgba(255,255,255,.7) 50%, transparent 60%),
        radial-gradient(1.5px 1.5px at 50% 50%, rgba(255,255,255,.6) 50%, transparent 60%),
        radial-gradient(2px 2px at 90% 30%, rgba(255,255,255,.9) 50%, transparent 60%);
      opacity: .25;
      animation: twinkle 10s linear infinite;
      pointer-events: none;
      z-index: 0;
    }
    .hero::after {
      filter: blur(1px);
      opacity: .2;
      animation-duration: 14s;
    }
    @keyframes twinkle {
      0% { transform: translateY(0); }
      50% { transform: translateY(8px); }
      100% { transform: translateY(0); }
    }

    .hero-inner {
      position: relative;
      z-index: 1;
      display: grid;
      gap: 18px;
      align-items: center;
    }
    .title-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }
    .title h1 {
      margin: 0;
      font-size: clamp(24px, 3.2vw, 42px);
      font-weight: 800;
      letter-spacing: .3px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-shadow: 0 6px 30px rgba(0,0,0,.25);
    }
    .title h1 .badge {
      font-size: clamp(12px, 1.8vw, 14px);
      color: var(--muted);
      font-weight: 600;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      height: 40px;
      padding: 0 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, background .2s ease;
      box-shadow: var(--shadow);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn-ghost { background: transparent; box-shadow: none; }
    .btn .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--good);
      box-shadow: 0 0 0 0 rgba(124, 243, 192, .8);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(124, 243, 192, .7) }
      70% { box-shadow: 0 0 0 10px rgba(124, 243, 192, 0) }
      100% { box-shadow: 0 0 0 0 rgba(124, 243, 192, 0) }
    }

    .searchbar {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px 10px 12px;
      box-shadow: var(--shadow);
      max-width: 680px;
      width: 100%;
    }
    .searchbar input {
      width: 100%;
      background: transparent;
      border: 0;
      outline: 0;
      color: var(--text);
      font-size: 15px;
    }
    .searchbar .clear {
      visibility: hidden;
    }
    .searchbar.has-text .clear { visibility: visible; cursor: pointer; }
    .subtle {
      color: var(--muted);
      font-size: 13px;
    }

    /* ============ TOP HEADLINES CAROUSEL ============ */
    .carousel {
      margin-top: 8px;
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
    }
    .slides {
      position: relative;
      height: clamp(220px, 35vw, 340px);
    }
    .slide {
      position: absolute; inset: 0;
      opacity: 0; transform: scale(1.02);
      transition: opacity .6s ease, transform .6s ease;
      background: #0f1533 center/cover no-repeat;
    }
    .slide.active { opacity: 1; transform: scale(1); }
    .slide::after {
      content: "";
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,.2), rgba(0,0,0,.6));
    }
    .slide-content {
      position: absolute; left: 0; right: 0; bottom: 0;
      padding: 20px 18px;
      z-index: 2;
      display: grid; gap: 6px;
    }
    .slide-title {
      font-weight: 800;
      font-size: clamp(16px, 2.1vw, 22px);
      text-shadow: 0 6px 30px rgba(0,0,0,.6);
    }
    .slide-meta {
      color: #d9e0ff;
      font-size: 13px;
      opacity: .95;
    }
    .carousel-nav {
      position: absolute; right: 10px; bottom: 10px;
      display: flex; gap: 8px; z-index: 3;
    }
    .dot {
      width: 9px; height: 9px; border-radius: 50%;
      background: rgba(255,255,255,.45);
      border: 1px solid rgba(255,255,255,.5);
      cursor: pointer;
      transition: transform .15s ease, background .2s ease;
    }
    .dot.active { background: var(--accent); transform: scale(1.2); }

    /* ============ CATEGORY SECTIONS ============ */
    section.category {
      margin: 24px 0;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: clip;
      background: var(--bg-elev);
      box-shadow: var(--shadow);
    }
    .cat-header {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
      border-bottom: 1px solid var(--line);
      cursor: default;
      user-select: none;
    }
    .cat-title {
      display: flex; align-items: center; gap: 10px;
      font-weight: 800; letter-spacing: .2px;
    }
    .cat-title .count {
      color: var(--muted); font-weight: 600; font-size: 13px;
      border: 1px solid var(--line);
      padding: 2px 8px; border-radius: 999px;
      background: var(--card-2);
    }
    .cat-actions {
      display: flex; align-items: center; gap: 8px;
    }
    .collapse-btn {
      display: inline-flex; align-items: center; gap: 6px;
      border: 1px solid var(--line);
      background: var(--card);
      padding: 6px 10px; border-radius: 999px;
      color: var(--muted); cursor: pointer;
    }
    .collapse-btn svg { transition: transform .2s ease; }
    .category.collapsed .collapse-btn svg { transform: rotate(-90deg); }

    .news-grid {
      display: grid;
      grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) );
      gap: 12px;
      padding: 12px;
    }

    /* ============ CARD ============ */
    .card {
      display: grid;
      grid-template-rows: 150px auto;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: var(--card);
      transform: translateZ(0);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      will-change: transform;
      position: relative;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      border-color: color-mix(in oklab, var(--accent) 40%, var(--line));
    }
    .thumb {
      position: relative;
      background: linear-gradient(135deg, #1f2545, #11162b);
      display: grid; place-items: center;
      overflow: hidden;
    }
    .thumb img {
      width: 100%; height: 100%; object-fit: cover;
      transform: scale(1.03);
      transition: transform .4s ease, filter .4s ease;
    }
    .card:hover .thumb img { transform: scale(1.06); filter: saturate(1.05) contrast(1.05); }
    .thumb .fallback {
      font-size: 46px; opacity: .85;
    }
    .content {
      padding: 12px;
      display: grid; gap: 8px;
    }
    .title {
      font-weight: 800;
      line-height: 1.3;
      font-size: 15px;
    }
    .desc {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-height: 3.8em;
      overflow: hidden;
    }
    .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }
    .source {
      display: inline-flex; align-items: center; gap: 8px;
    }
    .source img {
      width: 16px; height: 16px; border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
    }

    /* ============ SKELETON LOADING ============ */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.1), rgba(255,255,255,.04));
      background-size: 200% 100%;
      animation: shimmer 1.2s linear infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-card {
      border: 1px solid var(--line); border-radius: 14px; overflow: hidden; background: var(--card);
    }
    .skeleton-thumb { height: 150px; }
    .skeleton-body { padding: 12px; display: grid; gap: 8px; }
    .skeleton-line { height: 12px; border-radius: 6px; }
    .skeleton-line.short { width: 60%; }

    /* ============ FOOTER ============ */
    footer {
      margin: 36px 0 60px; color: var(--muted);
      font-size: 13px; text-align: center;
    }
    footer a { color: var(--accent); }

    /* ============ UTILITIES ============ */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn .35s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px) } to { opacity: 1; transform: translateY(0) } }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 720px) {
      .title-row { grid-template-columns: 1fr; }
      .controls { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="container hero-inner">
      <div class="title-row">
        <div class="title">
          <h1>üöÄ Space News & Updates <span class="badge subtle">Live ‚Ä¢ Auto-refresh</span></h1>
          <div class="subtle" id="lastUpdated">Last updated: ‚Äî</div>
        </div>
        <div class="controls">
          <button class="btn" id="refreshBtn" title="Refresh now">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path fill="currentColor" d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5a5 5 0 0 1-9.9 1h-2.02A7.002 7.002 0 0 0 19 13c0-3.87-3.13-7-7-7z"/></svg>
            Refresh
            <span class="dot" id="liveDot" aria-hidden="true"></span>
          </button>
          <button class="btn btn-ghost" id="themeToggle" title="Toggle dark/light mode">
            <svg id="iconMoon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M21.64 13a9 9 0 1 1-10.63-10.6 1 1 0 0 1 1.11 1.47A7 7 0 1 0 20.17 11.9a1 1 0 0 1 1.47 1.1z"/></svg>
            <span id="themeLabel">Dark</span>
          </button>
        </div>
      </div>

      <div class="searchbar" id="searchbar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 4a6 6 0 1 1-3.87 10.6l-3.26 3.27-1.41-1.42 3.27-3.26A6 6 0 0 1 10 4m0 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/></svg>
        <input id="searchInput" type="search" placeholder="Search news by keyword (e.g., JWST, Artemis, asteroid)..." />
        <span class="clear subtle" id="clearSearch" title="Clear">‚úï</span>
      </div>

      <div class="carousel" aria-label="Top Headlines">
        <div class="slides" id="slides"></div>
        <div class="carousel-nav" id="carouselDots"></div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Categories -->
    <section class="category" id="cat-planets">
      <div class="cat-header">
        <div class="cat-title">üåç Planets & Astronomy <span class="count" id="count-planets">0</span></div>
        <div class="cat-actions">
          <button class="collapse-btn" data-target="grid-planets" title="Collapse/Expand">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
            Collapse
          </button>
        </div>
      </div>
      <div class="news-grid" id="grid-planets"></div>
    </section>

    <section class="category" id="cat-agencies">
      <div class="cat-header">
        <div class="cat-title">üöÄ NASA & Space Agencies <span class="count" id="count-agencies">0</span></div>
        <div class="cat-actions">
          <button class="collapse-btn" data-target="grid-agencies" title="Collapse/Expand">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
            Collapse
          </button>
        </div>
      </div>
      <div class="news-grid" id="grid-agencies"></div>
    </section>

    <section class="category" id="cat-asteroids">
      <div class="cat-header">
        <div class="cat-title">‚òÑÔ∏è Asteroids, Meteors & Comets <span class="count" id="count-asteroids">0</span></div>
        <div class="cat-actions">
          <button class="collapse-btn" data-target="grid-asteroids" title="Collapse/Expand">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
            Collapse
          </button>
        </div>
      </div>
      <div class="news-grid" id="grid-asteroids"></div>
    </section>

    <section class="category" id="cat-tech">
      <div class="cat-header">
        <div class="cat-title">üõ∞Ô∏è Space Technology & Missions <span class="count" id="count-tech">0</span></div>
        <div class="cat-actions">
          <button class="collapse-btn" data-target="grid-tech" title="Collapse/Expand">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
            Collapse
          </button>
        </div>
      </div>
      <div class="news-grid" id="grid-tech"></div>
    </section>

    <section class="category" id="cat-human">
      <div class="cat-header">
        <div class="cat-title">üë©‚ÄçüöÄ Human Spaceflight <span class="count" id="count-human">0</span></div>
        <div class="cat-actions">
          <button class="collapse-btn" data-target="grid-human" title="Collapse/Expand">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
            Collapse
          </button>
        </div>
      </div>
      <div class="news-grid" id="grid-human"></div>
    </section>
  </main>

  <footer class="container">
    <p>¬© <span id="year"></span> Space News & Updates. Aggregated from public RSS feeds: NASA, Space.com, Spaceflight Now, BBC Science, Phys.org, Google News RSS, and more.</p>
    <p>Thumbnails and content belong to their respective publishers. This site uses public CORS proxies to fetch RSS in the browser.</p>
  </footer>

  <script>
    /*
      Space News & Updates
      - Single-file app for dynamic, categorized space news
      - Pure HTML/CSS/JS (no frameworks)
      - Uses public CORS proxies to fetch RSS in the browser
      - Auto-refresh, search, top headlines carousel, dark/light mode, collapsible sections

      Customize:
      - Add/remove sources in FEEDS
      - Tweak CATEGORY_KEYWORDS to adjust categorization
      - Change MAX_PER_CATEGORY or REFRESH_MS
    */

    // ---------- Configuration ----------
    const REFRESH_MS = 10 * 60 * 1000; // 10 minutes auto-refresh
    const MAX_PER_CATEGORY = 30;       // cap per category
    const MAX_TOP_HEADLINES = 8;       // carousel items

    // CORS proxies to try (in order)
    const PROXIES = [
      (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      (url) => `https://cors.isomorphic-git.org/${url}`,
      (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
      (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
    ];

    // RSS/Atom feeds (add or remove as needed)
    // hintCategories ensures items from that feed appear in those sections if keyword matching is weak.
    const FEEDS = [
      { url: 'https://www.nasa.gov/rss/dyn/breaking_news.rss', hintCategories: ['agencies'] },
      { url: 'https://spaceflightnow.com/feed/', hintCategories: ['tech', 'agencies'] },
      { url: 'https://www.space.com/feeds/all', hintCategories: ['planets','tech','agencies','human','asteroids'] },
      { url: 'http://feeds.bbci.co.uk/news/science_and_environment/rss.xml', hintCategories: ['planets','tech','asteroids','agencies','human'] },
      { url: 'https://phys.org/rss-feed/space-news/', hintCategories: ['planets','tech','asteroids'] },

      // Google News RSS searches
      { url: 'https://news.google.com/rss/search?q=astronomy%20OR%20planet%20OR%20exoplanet%20OR%20galaxy%20OR%20telescope%20OR%20JWST&hl=en-US&gl=US&ceid=US:en', hintCategories: ['planets'] },
      { url: 'https://news.google.com/rss/search?q=NASA%20OR%20ESA%20OR%20ISRO%20OR%20SpaceX%20OR%20Roscosmos%20OR%20CNSA&hl=en-US&gl=US&ceid=US:en', hintCategories: ['agencies'] },
      { url: 'https://news.google.com/rss/search?q=asteroid%20OR%20meteor%20OR%20comet%20OR%20meteoroid%20OR%20meteorite%20space&hl=en-US&gl=US&ceid=US:en', hintCategories: ['asteroids'] },
      { url: 'https://news.google.com/rss/search?q=satellite%20OR%20rocket%20OR%20launch%20OR%20spacecraft%20OR%20mission%20space&hl=en-US&gl=US&ceid=US:en', hintCategories: ['tech'] },
      { url: 'https://news.google.com/rss/search?q=astronaut%20OR%20ISS%20OR%20spacewalk%20OR%20crew%20dragon%20OR%20starliner%20OR%20human%20spaceflight&hl=en-US&gl=US&ceid=US:en', hintCategories: ['human'] },
    ];

    // Keyword-based categorization (case-insensitive)
    const CATEGORY_KEYWORDS = {
      planets: [
        'planet','exoplanet','galaxy','telescope','hubble','jwst','webb','alma','pulsar','black hole','nebula','cosmology','astronomy','milky way','kepler','transit','spectrograph'
      ],
      agencies: [
        'nasa','esa','isro','cnsa','roscosmos','jaxa','space agency','space force','spacex','blue origin','rocket lab','ula','arianespace','darpa','boeing','northrop','lockheed','european space agency'
      ],
      asteroids: [
        'asteroid','meteor','meteoroid','meteorite','comet','neo','near-earth object','bolide','apophis','bennu','didymos','dimorphos','dart','osiris-rex'
      ],
      tech: [
        'satellite','rover','probe','mission','launch','rocket','payload','spacecraft','instrument','lander','cubesat','capsule','starlink','orion','artemis','starship','booster','upper stage','constellation'
      ],
      human: [
        'astronaut','cosmonaut','taikonaut','iss','spacewalk','eva','crew','crew dragon','starliner','spacesuit','habitat','moon mission','mars mission','gateway','lunar'
      ],
    };

    // ---------- State ----------
    const state = {
      articles: [],              // flat list of all articles
      categories: { planets: [], agencies: [], asteroids: [], tech: [], human: [] },
      collapsed: new Set(),      // ids of collapsed grids
      lastUpdated: null,
      carouselIndex: 0,
      carouselTimer: null,
      searchQuery: '',
    };

    // ---------- DOM ----------
    const grids = {
      planets: document.getElementById('grid-planets'),
      agencies: document.getElementById('grid-agencies'),
      asteroids: document.getElementById('grid-asteroids'),
      tech: document.getElementById('grid-tech'),
      human: document.getElementById('grid-human'),
    };
    const counts = {
      planets: document.getElementById('count-planets'),
      agencies: document.getElementById('count-agencies'),
      asteroids: document.getElementById('count-asteroids'),
      tech: document.getElementById('count-tech'),
      human: document.getElementById('count-human'),
    };
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const slidesEl = document.getElementById('slides');
    const dotsEl = document.getElementById('carouselDots');
    const refreshBtn = document.getElementById('refreshBtn');
    const liveDot = document.getElementById('liveDot');
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const searchbar = document.getElementById('searchbar');

    // ---------- Utilities ----------
    function timeAgo(date) {
      try {
        const d = typeof date === 'string' ? new Date(date) : date;
        const s = Math.floor((Date.now() - d.getTime()) / 1000);
        if (s < 60) return `${s}s ago`;
        const m = Math.floor(s / 60);
        if (m < 60) return `${m}m ago`;
        const h = Math.floor(m / 60);
        if (h < 24) return `${h}h ago`;
        const d2 = Math.floor(h / 24);
        if (d2 < 14) return `${d2}d ago`;
        // Fallback to date
        return d.toLocaleString();
      } catch {
        return '';
      }
    }
    function formatDate(date) {
      try {
        const d = typeof date === 'string' ? new Date(date) : date;
        return d.toLocaleString([], { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      } catch { return ''; }
    }
    function domainFromUrl(url) {
      try { return new URL(url).hostname.replace(/^www\./,''); }
      catch { return ''; }
    }
    function stripHtml(html) {
      const tmp = document.createElement('div'); tmp.innerHTML = html || '';
      return tmp.textContent || tmp.innerText || '';
    }
    function clamp(str, max=220) {
      if (!str) return '';
      const s = str.trim().replace(/\s+/g,' ');
      return s.length > max ? s.slice(0, max-1) + '‚Ä¶' : s;
    }
    function saveLS(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }
    function loadLS(key, fallback) {
      try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
    }

    // ---------- Fetch with fallback proxies ----------
    async function fetchWithProxies(url) {
      for (const make of PROXIES) {
        const proxied = make(url);
        try {
          const res = await fetch(proxied, { headers: { 'Accept': 'application/rss+xml, application/xml, text/xml, text/html, */*' }, referrerPolicy: 'no-referrer' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          if (text && text.length > 50) return text;
        } catch (e) {
          // try next proxy
        }
      }
      // As a last attempt, try direct (often blocked by CORS)
      try {
        const res = await fetch(url);
        if (res.ok) return await res.text();
      } catch {}
      throw new Error('All proxies failed for ' + url);
    }

    // ---------- Parse RSS/Atom to normalized article objects ----------
    function parseFeed(xmlText, sourceUrl, hintCategories=[]) {
      const out = [];
      let doc;
      try {
        doc = new DOMParser().parseFromString(xmlText, 'application/xml');
        if (doc.querySelector('parsererror')) throw new Error('Invalid XML');
      } catch {
        return out;
      }

      const isAtom = !!doc.querySelector('feed');
      const items = isAtom ? [...doc.querySelectorAll('entry')] : [...doc.querySelectorAll('item')];

      for (const it of items) {
        const title = (it.querySelector('title')?.textContent || '').trim();
        // Link can be <link> (RSS text) or <link href="..."> (Atom)
        let link = '';
        if (isAtom) {
          const l = it.querySelector('link[rel="alternate"]') || it.querySelector('link');
          link = l?.getAttribute('href') || l?.textContent || '';
        } else {
          link = it.querySelector('link')?.textContent?.trim() || '';
        }
        // Description / content
        const descHtml = it.querySelector('description')?.textContent || it.querySelector('content')?.textContent || it.querySelector('content\\:encoded')?.textContent || '';
        const description = stripHtml(descHtml);

        // Dates: pubDate, updated, published
        const pubDate = it.querySelector('pubDate')?.textContent
                      || it.querySelector('updated')?.textContent
                      || it.querySelector('published')?.textContent
                      || new Date().toISOString();

        // Source/domain
        const source = domainFromUrl(link) || domainFromUrl(sourceUrl) || 'Source';

        // Try image
        let image = null;
        const mediaContent = it.querySelector('media\\:content, content');
        const mediaThumb = it.querySelector('media\\:thumbnail');
        const enclosure = it.querySelector('enclosure[url]');
        if (mediaContent?.getAttribute?.('url')) image = mediaContent.getAttribute('url');
        else if (mediaThumb?.getAttribute?.('url')) image = mediaThumb.getAttribute('url');
        else if (enclosure?.getAttribute?.('url')) image = enclosure.getAttribute('url');
        else {
          // Extract first <img> from description HTML, if present
          try {
            const htmlDoc = new DOMParser().parseFromString(descHtml, 'text/html');
            const img = htmlDoc.querySelector('img');
            if (img?.src) image = img.src;
          } catch {}
        }
        // Clean up relative URLs
        if (image && image.startsWith('//')) image = location.protocol + image;

        out.push({
          id: link || title + '|' + pubDate,
          title,
          link,
          description,
          source,
          pubDate: new Date(pubDate),
          image: image || null,
          hintCategories: hintCategories.slice(0),
        });
      }
      return out;
    }

    // ---------- Categorization ----------
    function categorize(article) {
      const matched = new Set(article.hintCategories || []);
      const hay = (article.title + ' ' + article.description).toLowerCase();

      for (const [cat, keys] of Object.entries(CATEGORY_KEYWORDS)) {
        for (const k of keys) {
          if (hay.includes(k)) { matched.add(cat); break; }
        }
      }
      // If nothing matched, try simple heuristics on domain
      if (!matched.size) {
        const d = article.source.toLowerCase();
        if (/(nasa|esa|isro|jaxa|roscosmos|spacex|ula|ariane)/.test(d)) matched.add('agencies');
        else if (/(spaceflightnow|nasaspaceflight)/.test(d)) matched.add('tech');
        else if (/(space\.com|phys\.org|newscientist|scientificamerican)/.test(d)) matched.add('planets');
      }

      // Limit to at most 2 categories to avoid duplication overload
      const cats = [...matched].slice(0, 2);
      if (!cats.length) cats.push('planets'); // default fallback
      return cats;
    }

    // ---------- Rendering ----------
    function placeholderSkeletons(count = 6) {
      const frag = document.createDocumentFragment();
      for (let i=0;i<count;i++) {
        const s = document.createElement('div');
        s.className = 'skeleton-card';
        s.innerHTML = `
          <div class="skeleton skeleton-thumb"></div>
          <div class="skeleton-body">
            <div class="skeleton skeleton-line" style="width:90%"></div>
            <div class="skeleton skeleton-line"></div>
            <div class="skeleton skeleton-line short"></div>
          </div>
        `;
        frag.appendChild(s);
      }
      return frag;
    }

    function clearGridsToSkeletons() {
      for (const grid of Object.values(grids)) {
        grid.innerHTML = '';
        grid.appendChild(placeholderSkeletons(8));
      }
      slidesEl.innerHTML = '';
      dotsEl.innerHTML = '';
    }

    function render() {
      // Reset grids
      for (const [cat, grid] of Object.entries(grids)) {
        grid.innerHTML = '';
        const list = state.categories[cat]
          .filter(a => filterBySearch(a, state.searchQuery))
          .slice(0, MAX_PER_CATEGORY);

        counts[cat].textContent = list.length;
        if (!list.length) {
          const empty = document.createElement('div');
          empty.className = 'subtle';
          empty.style.padding = '14px';
          empty.textContent = 'No articles found.';
          grid.appendChild(empty);
          continue;
        }

        const frag = document.createDocumentFragment();
        for (const a of list) {
          const card = document.createElement('a');
          card.className = 'card fade-in';
          card.href = a.link || '#';
          card.target = '_blank';
          card.rel = 'noopener noreferrer';

          const favicon = `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(a.source)}`;
          const thumb = a.image
            ? `<img src="${sanitize(a.image)}" alt="">`
            : `<div class="fallback" aria-hidden="true">üõ∞Ô∏è</div>`;

          card.innerHTML = `
            <div class="thumb">${thumb}</div>
            <div class="content">
              <div class="title">${escapeHtml(a.title)}</div>
              <div class="desc">${escapeHtml(clamp(a.description, 200))}</div>
              <div class="meta">
                <span class="source">
                  <img src="${favicon}" alt="" loading="lazy">
                  ${escapeHtml(prettySource(a.source))}
                </span>
                <span class="time" title="${formatDate(a.pubDate)}">${timeAgo(a.pubDate)}</span>
              </div>
            </div>
          `;
          frag.appendChild(card);
        }

        grid.appendChild(frag);
      }

      // Carousel for top headlines
      buildCarousel();
      // Last updated
      if (state.lastUpdated) {
        lastUpdatedEl.textContent = `Last updated: ${formatDate(state.lastUpdated)}`;
      }
    }

    function buildCarousel() {
      slidesEl.innerHTML = '';
      dotsEl.innerHTML = '';
      const all = state.articles
        .filter(a => filterBySearch(a, state.searchQuery))
        .sort((a,b) => b.pubDate - a.pubDate);

      const seen = new Set();
      const top = [];
      for (const a of all) {
        const key = a.link || a.id;
        if (seen.has(key)) continue;
        seen.add(key);
        top.push(a);
        if (top.length >= MAX_TOP_HEADLINES) break;
      }

      if (!top.length) {
        const placeholder = document.createElement('div');
        placeholder.className = 'slide active';
        placeholder.style.background = 'linear-gradient(135deg,#2a2f60,#0b1020)';
        placeholder.innerHTML = `
          <div class="slide-content">
            <div class="slide-title">Exploring the cosmos...</div>
            <div class="slide-meta">Fresh headlines will appear here shortly.</div>
          </div>
        `;
        slidesEl.appendChild(placeholder);
        return;
      }

      top.forEach((a, i) => {
        const slide = document.createElement('a');
        slide.className = 'slide';
        slide.href = a.link || '#';
        slide.target = '_blank';
        slide.rel = 'noopener noreferrer';
        slide.style.backgroundImage = a.image
          ? `url("${sanitize(a.image)}")`
          : 'linear-gradient(135deg,#1f2545,#0b1020)';

        slide.innerHTML = `
          <div class="slide-content">
            <div class="slide-title">${escapeHtml(a.title)}</div>
            <div class="slide-meta">${escapeHtml(prettySource(a.source))} ‚Ä¢ ${timeAgo(a.pubDate)}</div>
          </div>
        `;
        slidesEl.appendChild(slide);

        const dot = document.createElement('span');
        dot.className = 'dot';
        dot.addEventListener('click', () => {
          setCarouselIndex(i, true);
        });
        dotsEl.appendChild(dot);
      });

      state.carouselIndex = 0;
      setCarouselIndex(0, false);
      restartCarouselTimer();
    }

    function setCarouselIndex(idx, user) {
      const slides = [...slidesEl.children];
      const dots = [...dotsEl.children];
      if (!slides.length) return;

      state.carouselIndex = (idx + slides.length) % slides.length;
      slides.forEach((el, i) => el.classList.toggle('active', i === state.carouselIndex));
      dots.forEach((el, i) => el.classList.toggle('active', i === state.carouselIndex));
      if (user) restartCarouselTimer();
    }

    function restartCarouselTimer() {
      clearInterval(state.carouselTimer);
      state.carouselTimer = setInterval(() => {
        setCarouselIndex(state.carouselIndex + 1, false);
      }, 5000);
    }

    function prettySource(domain) {
      // Improve readability for known domains
      const map = {
        'spaceflightnow.com': 'Spaceflight Now',
        'space.com': 'Space.com',
        'nasa.gov': 'NASA',
        'bbc.co.uk': 'BBC',
        'bbc.com': 'BBC',
        'phys.org': 'Phys.org',
        'news.google.com': 'Google News',
      };
      const d = domain.toLowerCase();
      return map[d] || d.replace(/\.(com|org|net|co\.uk)$/,'');
    }

    function sanitize(url) {
      // Basic escape for quotes in URL attribute
      return String(url).replace(/"/g, '&quot;');
    }
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function filterBySearch(article, query) {
      if (!query) return true;
      const q = query.trim().toLowerCase();
      if (!q) return true;
      return (article.title && article.title.toLowerCase().includes(q)) ||
             (article.description && article.description.toLowerCase().includes(q)) ||
             (article.source && article.source.toLowerCase().includes(q));
    }

    // ---------- Load All Feeds ----------
    async function loadAll() {
      liveDot.style.background = 'var(--accent)';
      state.lastUpdated = new Date();

      clearGridsToSkeletons();

      try {
        const allArticles = [];
        const seen = new Set();

        // Fetch in parallel
        const results = await Promise.allSettled(
          FEEDS.map(async f => {
            const xml = await fetchWithProxies(f.url);
            const parsed = parseFeed(xml, f.url, f.hintCategories);
            return parsed;
          })
        );

        for (let i = 0; i < results.length; i++) {
          const r = results[i];
          const feed = FEEDS[i];
          if (r.status === 'fulfilled') {
            for (const a of r.value) {
              // Deduplicate by normalized link or title|date
              const key = (a.link || a.id || '').trim();
              if (!key) continue;
              const normKey = key.replace(/[#?].*$/,''); // ignore URL fragments/queries for dedupe
              if (seen.has(normKey)) continue;
              seen.add(normKey);

              // Categorize
              const cats = categorize(a);
              a._cats = cats;
              allArticles.push(a);
            }
          } else {
            // optionally log: console.warn('Feed failed', feed.url, r.reason);
          }
        }

        // Sort all by date desc
        allArticles.sort((a,b) => (b.pubDate || 0) - (a.pubDate || 0));

        // Fill categories
        const cats = { planets: [], agencies: [], asteroids: [], tech: [], human: [] };
        for (const a of allArticles) {
          for (const c of a._cats) {
            if (cats[c]) cats[c].push(a);
          }
        }

        state.articles = allArticles;
        state.categories = cats;
      } catch (e) {
        // In case of total failure, show message
        for (const grid of Object.values(grids)) {
          grid.innerHTML = '<div class="subtle" style="padding:14px">Failed to load feeds. Please try again.</div>';
        }
      } finally {
        liveDot.style.background = 'var(--good)';
        render();
      }
    }

    // ---------- Collapsible sections ----------
    function setupCollapsibles() {
      document.querySelectorAll('.collapse-btn').forEach(btn => {
        const targetId = btn.getAttribute('data-target');
        const grid = document.getElementById(targetId);
        btn.addEventListener('click', () => {
          const section = grid.closest('.category');
          section.classList.toggle('collapsed');
          if (section.classList.contains('collapsed')) {
            grid.style.display = 'none';
            state.collapsed.add(targetId);
          } else {
            grid.style.display = '';
            state.collapsed.delete(targetId);
          }
          saveLS('collapsedGrids', [...state.collapsed]);
        });

        // Restore state
        const coll = loadLS('collapsedGrids', []);
        state.collapsed = new Set(coll);
        if (state.collapsed.has(targetId)) {
          const section = grid.closest('.category');
          section.classList.add('collapsed');
          grid.style.display = 'none';
        }
      });
    }

    // ---------- Theme ----------
    function setupTheme() {
      const saved = loadLS('theme', 'dark');
      document.documentElement.setAttribute('data-theme', saved);
      themeLabel.textContent = saved === 'dark' ? 'Dark' : 'Light';

      themeToggle.addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        themeLabel.textContent = next === 'dark' ? 'Dark' : 'Light';
        saveLS('theme', next);
      });
    }

    // ---------- Search ----------
    function setupSearch() {
      const savedQuery = loadLS('searchQuery', '');
      if (savedQuery) {
        searchInput.value = savedQuery;
        state.searchQuery = savedQuery;
        searchbar.classList.add('has-text');
      }

      searchInput.addEventListener('input', () => {
        state.searchQuery = searchInput.value;
        saveLS('searchQuery', state.searchQuery);
        searchbar.classList.toggle('has-text', !!state.searchQuery);
        render();
      });
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchInput.value = '';
          state.searchQuery = '';
          saveLS('searchQuery', '');
          searchbar.classList.remove('has-text');
          render();
        }
      });
      clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        state.searchQuery = '';
        saveLS('searchQuery', '');
        searchbar.classList.remove('has-text');
        render();
      });
    }

    // ---------- Refresh ----------
    function setupRefresh() {
      refreshBtn.addEventListener('click', () => loadAll());
      setInterval(() => loadAll(), REFRESH_MS);
    }

    // ---------- Init ----------
    (function init() {
      document.getElementById('year').textContent = new Date().getFullYear();
      setupTheme();
      setupCollapsibles();
      setupSearch();
      setupRefresh();
      loadAll();
    })();

  </script>
</body>
</html>